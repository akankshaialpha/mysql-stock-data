import time
import multiprocessing
import sqlalchemy as db
import mysql
import mysql.connector
import glob
import os
import pandas as pd
connection_ = mysql.connector.connect(host='localhost', port = 3306, user='akanksha', password='password')
cursor = connection_.cursor()
engine = db.create_engine('mysql+mysqlconnector://akanksha:password!@localhost:3306', echo=False)
connection = engine.connect()

year_df = pd.DataFrame([
       ('01','2008'),
       ('02','2009'),
       ('03','2010'),
       ('04','2011'),
       ('05','2012'),
       ('06','2013'),
       ('07','2014'),
       ('08','2015'),
       ('09','2016'),
       ('10','2017'),
       ('11','2018'),
       ('12','2019'),
       ('13','2020')], columns=['yid','year_col'])
year_df = year_df.set_index('year_col')
month_df = pd.DataFrame([
       ('01','1'),
       ('02','2'),
       ('03','3'),
       ('04','4'),
       ('05','5'),
       ('06','6'),
       ('07','7'),
       ('08','8'),
       ('09','9'),
       ('10','10'),
       ('11','11'),
       ('12','12')], columns=['mid','month_col'])
month_df = month_df.set_index('month_col')
day_df = pd.DataFrame([
       ('01','1'),
       ('02','2'),
       ('03','3'),
       ('04','4'),
       ('05','5'),
       ('06','6'),
       ('07','7'),
       ('08','8'),
       ('09','9'),
       ('10','10'),
       ('11','11'),
       ('12','12'),
       ('13','13'),
       ('14','14'),
       ('15','15'),
       ('16','16'),
       ('17','17'),
       ('18','18'),
       ('19','19'),
       ('20','20'),
       ('21','21'),
       ('22','22'),
       ('23','23'),
       ('24','24'),
       ('25','25'),
       ('26','26'),
       ('27','27'),
       ('28','28'),
       ('29','29'),
       ('30','30'),
       ('31','31')], columns = ['did','day_col'])
day_df = day_df.set_index('day_col')
time_df = pd.DataFrame([
       ('001' , '09:30:00'),
       ('002',	'09:31:00'),
       ('003',	'09:32:00'),
       ('004',	'09:33:00'),
       ('005',	'09:34:00'),
       ('006',	'09:35:00'),
       ('007',	'09:36:00'),
       ('008',	'09:37:00'),
       ('009',	'09:38:00'),
       ('010','09:39:00'),
       ('011','09:40:00'),
       ('012','09:41:00'),
       ('013','09:42:00'),
       ('014','09:43:00'),
       ('015','09:44:00'),
       ('016','09:45:00'),
       ('017','09:46:00'),
       ('018','09:47:00'),
       ('019','09:48:00'),
       ('020','09:49:00'),
       ('021','09:50:00'),
       ('022','09:51:00'),
       ('023','09:52:00'),
       ('024','09:53:00'),
       ('025','09:54:00'),
       ('026','09:55:00'),
       ('027','09:56:00'),
       ('028','09:57:00'),
       ('029','09:58:00'),
       ('030','09:59:00'),
       ('031','10:00:00'),
       ('032','10:01:00'),
       ('033','10:02:00'),
       ('034','10:03:00'),
       ('035','10:04:00'),
       ('036','10:05:00'),
       ('037','10:06:00'),
       ('038','10:07:00'),
       ('039','10:08:00'),
       ('040','10:09:00'),
       ('041','10:10:00'),
       ('042','10:11:00'),
       ('043','10:12:00'),
       ('044','10:13:00'),
       ('045','10:14:00'),
       ('046','10:15:00'),
       ('047','10:16:00'),
       ('048','10:17:00'),
       ('049','10:18:00'),
       ('050','10:19:00'),
       ('051','10:20:00'),
       ('052','10:21:00'),
       ('053','10:22:00'),
       ('054','10:23:00'),
       ('055','10:24:00'),
       ('056','10:25:00'),
       ('057','10:26:00'),
       ('058','10:27:00'),
       ('059','10:28:00'),
       ('060','10:29:00'),
       ('061','10:30:00'),
       ('062','10:31:00'),
       ('063','10:32:00'),
       ('064','10:33:00'),
       ('065','10:34:00'),
       ('066','10:35:00'),
       ('067','10:36:00'),
       ('068','10:37:00'),
       ('069','10:38:00'),
       ('070','10:39:00'),
       ('071','10:40:00'),
       ('072','10:41:00'),
       ('073','10:42:00'),
       ('074','10:43:00'),
       ('075','10:44:00'),
       ('076','10:45:00'),
       ('077','10:46:00'),
       ('078','10:47:00'),
       ('079','10:48:00'),
       ('080','10:49:00'),
       ('081','10:50:00'),
       ('082','10:51:00'),
       ('083','10:52:00'),
       ('084','10:53:00'),
       ('085','10:54:00'),
       ('086','10:55:00'),
       ('087','10:56:00'),
       ('088','10:57:00'),
       ('089','10:58:00'),
       ('090','10:59:00'),
       ('091','11:00:00'),
       ('092','11:01:00'),
       ('093','11:02:00'),
       ('094','11:03:00'),
       ('095','11:04:00'),
       ('096','11:05:00'),
       ('097','11:06:00'),
       ('098','11:07:00'),
       ('099','11:08:00'),
       ('100','11:09:00'),
       ('101','11:10:00'),
       ('102','11:11:00'),
       ('103','11:12:00'),
       ('104','11:13:00'),
       ('105','11:14:00'),
       ('106','11:15:00'),
       ('107','11:16:00'),
       ('108','11:17:00'),
       ('109','11:18:00'),
       ('110','11:19:00'),
       ('111','11:20:00'),
       ('112','11:21:00'),
       ('113','11:22:00'),
       ('114','11:23:00'),
       ('115','11:24:00'),
       ('116','11:25:00'),
       ('117','11:26:00'),
       ('118','11:27:00'),
       ('119','11:28:00'),
       ('120','11:29:00'),
       ('121','11:30:00'),
       ('122','11:31:00'),
       ('123','11:32:00'),
       ('124','11:33:00'),
       ('125','11:34:00'),
       ('126','11:35:00'),
       ('127','11:36:00'),
       ('128','11:37:00'),
       ('129','11:38:00'),
       ('130','11:39:00'),
       ('131','11:40:00'),
       ('132','11:41:00'),
       ('133','11:42:00'),
       ('134','11:43:00'),
       ('135','11:44:00'),
       ('136','11:45:00'),
       ('137','11:46:00'),
       ('138','11:47:00'),
       ('139','11:48:00'),
       ('140','11:49:00'),
       ('141','11:50:00'),
       ('142','11:51:00'),
       ('143','11:52:00'),
       ('144','11:53:00'),
       ('145','11:54:00'),
       ('146','11:55:00'),
       ('147','11:56:00'),
       ('148','11:57:00'),
       ('149','11:58:00'),
       ('150','11:59:00'),
       ('151','12:00:00'),
       ('152','12:01:00'),
       ('153','12:02:00'),
       ('154','12:03:00'),
       ('155','12:04:00'),
       ('156','12:05:00'),
       ('157','12:06:00'),
       ('158','12:07:00'),
       ('159','12:08:00'),
       ('160','12:09:00'),
       ('161','12:10:00'),
       ('162','12:11:00'),
       ('163','12:12:00'),
       ('164','12:13:00'),
       ('165','12:14:00'),
       ('166','12:15:00'),
       ('167','12:16:00'),
       ('168','12:17:00'),
       ('169','12:18:00'),
       ('170','12:19:00'),
       ('171','12:20:00'),
       ('172','12:21:00'),
       ('173','12:22:00'),
       ('174','12:23:00'),
       ('175','12:24:00'),
       ('176','12:25:00'),
       ('177','12:26:00'),
       ('178','12:27:00'),
       ('179','12:28:00'),
       ('180','12:29:00'),
       ('181','12:30:00'),
       ('182','12:31:00'),
       ('183','12:32:00'),
       ('184','12:33:00'),
       ('185','12:34:00'),
       ('186','12:35:00'),
       ('187','12:36:00'),
       ('188','12:37:00'),
       ('189','12:38:00'),
       ('190','12:39:00'),
       ('191','12:40:00'),
       ('192','12:41:00'),
       ('193','12:42:00'),
       ('194','12:43:00'),
       ('195','12:44:00'),
       ('196','12:45:00'),
       ('197','12:46:00'),
       ('198','12:47:00'),
       ('199','12:48:00'),
       ('200','12:49:00'),
       ('201','12:50:00'),
       ('202','12:51:00'),
       ('203','12:52:00'),
       ('204','12:53:00'),
       ('205','12:54:00'),
       ('206','12:55:00'),
       ('207','12:56:00'),
       ('208','12:57:00'),
       ('209','12:58:00'),
       ('210','12:59:00'),
       ('211','13:00:00'),
       ('212','13:01:00'),
       ('213','13:02:00'),
       ('214','13:03:00'),
       ('215','13:04:00'),
       ('216','13:05:00'),
       ('217','13:06:00'),
       ('218','13:07:00'),
       ('219','13:08:00'),
       ('220','13:09:00'),
       ('221','13:10:00'),
       ('222','13:11:00'),
       ('223','13:12:00'),
       ('224','13:13:00'),
       ('225','13:14:00'),
       ('226','13:15:00'),
       ('227','13:16:00'),
       ('228','13:17:00'),
       ('229','13:18:00'),
       ('230','13:19:00'),
       ('231','13:20:00'),
       ('232','13:21:00'),
       ('233','13:22:00'),
       ('234','13:23:00'),
       ('235','13:24:00'),
       ('236','13:25:00'),
       ('237','13:26:00'),
       ('238','13:27:00'),
       ('239','13:28:00'),
       ('240','13:29:00'),
       ('241','13:30:00'),
       ('242','13:31:00'),
       ('243','13:32:00'),
       ('244','13:33:00'),
       ('245','13:34:00'),
       ('246','13:35:00'),
       ('247','13:36:00'),
       ('248','13:37:00'),
       ('249','13:38:00'),
       ('250','13:39:00'),
       ('251','13:40:00'),
       ('252','13:41:00'),
       ('253','13:42:00'),
       ('254','13:43:00'),
       ('255','13:44:00'),
       ('256','13:45:00'),
       ('257','13:46:00'),
       ('258','13:47:00'),
       ('259','13:48:00'),
       ('260','13:49:00'),
       ('261','13:50:00'),
       ('262','13:51:00'),
       ('263','13:52:00'),
       ('264','13:53:00'),
       ('265','13:54:00'),
       ('266','13:55:00'),
       ('267','13:56:00'),
       ('268','13:57:00'),
       ('269','13:58:00'),
       ('270','13:59:00'),
       ('271','14:00:00'),
       ('272','14:01:00'),
       ('273','14:02:00'),
       ('274','14:03:00'),
       ('275','14:04:00'),
       ('276','14:05:00'),
       ('277','14:06:00'),
       ('278','14:07:00'),
       ('279','14:08:00'),
       ('280','14:09:00'),
       ('281','14:10:00'),
       ('282','14:11:00'),
       ('283','14:12:00'),
       ('284','14:13:00'),
       ('285','14:14:00'),
       ('286','14:15:00'),
       ('287','14:16:00'),
       ('288','14:17:00'),
       ('289','14:18:00'),
       ('290','14:19:00'),
       ('291','14:20:00'),
       ('292','14:21:00'),
       ('293','14:22:00'),
       ('294','14:23:00'),
       ('295','14:24:00'),
       ('296','14:25:00'),
       ('297','14:26:00'),
       ('298','14:27:00'),
       ('299','14:28:00'),
       ('300','14:29:00'),
       ('301','14:30:00'),
       ('302','14:31:00'),
       ('303','14:32:00'),
       ('304','14:33:00'),
       ('305','14:34:00'),
       ('306','14:35:00'),
       ('307','14:36:00'),
       ('308','14:37:00'),
       ('309','14:38:00'),
       ('310','14:39:00'),
       ('311','14:40:00'),
       ('312','14:41:00'),
       ('313','14:42:00'),
       ('314','14:43:00'),
       ('315','14:44:00'),
       ('316','14:45:00'),
       ('317','14:46:00'),
       ('318','14:47:00'),
       ('319','14:48:00'),
       ('320','14:49:00'),
       ('321','14:50:00'),
       ('322','14:51:00'),
       ('323','14:52:00'),
       ('324','14:53:00'),
       ('325','14:54:00'),
       ('326','14:55:00'),
       ('327','14:56:00'),
       ('328','14:57:00'),
       ('329','14:58:00'),
       ('330','14:59:00'),
       ('331','15:00:00'),
       ('332','15:01:00'),
       ('333','15:02:00'),
       ('334','15:03:00'),
       ('335','15:04:00'),
       ('336','15:05:00'),
       ('337','15:06:00'),
       ('338','15:07:00'),
       ('339','15:08:00'),
       ('340','15:09:00'),
       ('341','15:10:00'),
       ('342','15:11:00'),
       ('343','15:12:00'),
       ('344','15:13:00'),
       ('345','15:14:00'),
       ('346','15:15:00'),
       ('347','15:16:00'),
       ('348','15:17:00'),
       ('349','15:18:00'),
       ('350','15:19:00'),
       ('351','15:20:00'),
       ('352','15:21:00'),
       ('353','15:22:00'),
       ('354','15:23:00'),
       ('355','15:24:00'),
       ('356','15:25:00'),
       ('357','15:26:00'),
       ('358','15:27:00'),
       ('359','15:28:00'),
       ('360','15:29:00'),
       ('361','15:30:00'),
       ('362','15:31:00'),
       ('363','15:32:00'),
       ('364','15:33:00'),
       ('365','15:34:00'),
       ('366','15:35:00'),
       ('367','15:36:00'),
       ('368','15:37:00'),
       ('369','15:38:00'),
       ('370','15:39:00'),
       ('371','15:40:00'),
       ('372','15:41:00'),
       ('373','15:42:00'),
       ('374','15:43:00'),
       ('375','15:44:00'),
       ('376','15:45:00'),
       ('377','15:46:00'),
       ('378','15:47:00'),
       ('379','15:48:00'),
       ('380','15:49:00'),
       ('381','15:50:00'),
       ('382','15:51:00'),
       ('383','15:52:00'),
       ('384','15:53:00'),
       ('385','15:54:00'),
       ('386','15:55:00'),
       ('387','15:56:00'),
       ('388','15:57:00'),
       ('389','15:58:00'),
       ('390','15:59:00'),
       ('391','16:00:00')], columns=['tid','time_col'])
time_df = time_df.set_index('time_col')
tl_1 = pd.read_sql('SELECT * FROM dir.tl_1', engine)
tl_2 = pd.read_sql('SELECT * FROM dir.tl_2', engine)
tl_3 = pd.read_sql('SELECT * FROM dir.tl_3', engine)
tl_4 = pd.read_sql('SELECT * FROM dir.tl_4', engine)
tl_5 = pd.read_sql('SELECT * FROM dir.tl_5', engine)
tl_6 = pd.read_sql('SELECT * FROM dir.tl_6', engine)
tl_7 = pd.read_sql('SELECT * FROM dir.tl_7', engine)
tl_8 = pd.read_sql('SELECT * FROM dir.tl_8', engine)
tl_9 = pd.read_sql('SELECT * FROM dir.tl_9', engine)
tl_10 = pd.read_sql('SELECT * FROM dir.tl_10', engine)

tl_1['Stock_ID'] = tl_1['Stock_ID'].map(str)
tl_2['Stock_ID'] = tl_2['Stock_ID'].map(str)
tl_3['Stock_ID'] = tl_3['Stock_ID'].map(str)
tl_4['Stock_ID'] = tl_4['Stock_ID'].map(str)
tl_5['Stock_ID'] = tl_5['Stock_ID'].map(str)
tl_6['Stock_ID'] = tl_6['Stock_ID'].map(str)
tl_7['Stock_ID'] = tl_7['Stock_ID'].map(str)
tl_8['Stock_ID'] = tl_8['Stock_ID'].map(str)
tl_9['Stock_ID'] = tl_9['Stock_ID'].map(str)
tl_10['Stock_ID'] = tl_10['Stock_ID'].map(str)
tl_1 = tl_1.set_index('Symbol')
tl_2 = tl_2.set_index('Symbol')
tl_3 = tl_3.set_index('Symbol')
tl_4 = tl_4.set_index('Symbol')
tl_5 = tl_5.set_index('Symbol')
tl_6 = tl_6.set_index('Symbol')
tl_7 = tl_7.set_index('Symbol')
tl_8 = tl_8.set_index('Symbol')
tl_9 = tl_9.set_index('Symbol')
tl_10 = tl_10.set_index('Symbol')

dtp_dict = {}
tl_dict = {}
for i in tl_1.index.str[0].unique(): 
    tl_dict[i] = tl_1
    dtp_dict[i] = "dtp_1"
for i in tl_2.index.str[0].unique(): 
    tl_dict[i] = tl_2
    dtp_dict[i] = "dtp_2"
for i in tl_3.index.str[0].unique(): 
    tl_dict[i] = tl_3
    dtp_dict[i] = "dtp_3"
for i in tl_4.index.str[0].unique(): 
    tl_dict[i] = tl_4
    dtp_dict[i] = "dtp_4"
for i in tl_5.index.str[0].unique(): 
    tl_dict[i] = tl_5
    dtp_dict[i] = "dtp_5"
for i in tl_6.index.str[0].unique(): 
    tl_dict[i] = tl_6
    dtp_dict[i] = "dtp_6"
for i in tl_7.index.str[0].unique(): 
    tl_dict[i] = tl_7
    dtp_dict[i] = "dtp_7"
for i in tl_8.index.str[0].unique(): 
    tl_dict[i] = tl_8
    dtp_dict[i] = "dtp_8"
for i in tl_9.index.str[0].unique(): 
    tl_dict[i] = tl_9
    dtp_dict[i] = "dtp_9"
for i in tl_10.index.str[0].unique(): 
    tl_dict[i] = tl_10
    dtp_dict[i] = "dtp_10"

path='C:\\ProgramData\\MySQL\\MySQL Server 8.0\\Uploads\\'
ds_df = pd.DataFrame(columns=['ds_id'])
header = ['ds_id','Open','High','Low','Close','Volume']
def save_txt(df_, filename, tbl):
    for name, data in df_.groupby(df_['Date'].dt.year):
        tbl1 = 'y'+str(name)+'.'+tbl
        data.to_csv(path+filename+"_"+str(name)+".txt", columns = header, index=False)
        sql_query = 'LOAD DATA INFILE \'c:/programdata/mysql/mysql server 8.0/uploads/'+ filename+'_'+str(name)+'.txt'+ '\' INTO TABLE '+ tbl1+ ' FIELDS TERMINATED BY ' + '\',\'' + ' IGNORE 1 LINES (ds_id, open, high, low, close, volume)'
        cursor.execute(sql_query)
        connection_.commit()
        os.remove(path+filename+"_"+str(name)+".txt")

def create_df(dff, file_):
    dff = pd.read_csv(file_, parse_dates=['Date'])
    return dff 

def add_col(ddff):
    ddff = pd.concat([ds_df, ddff], axis=1)
    return ddff

def map_column(ddf, tl_df):
    ddf['ds_id'] = ddf['Date'].dt.year.map(str).map(year_df['yid']) + ddf['Date'].dt.month.map(str).map(month_df['mid']) + ddf['Date'].dt.day.map(str).map(day_df['did']) + ddf['Date'].dt.time.map(str).map(time_df['tid']) + ddf['Ticker'].map(tl_df['Stock_ID'])    
    return ddf
#---------------------------------------------------------------------------------------------------------------
def process_dataframes(file):
    df = pd.DataFrame()
    (df.pipe(create_df, file)
       .pipe(add_col)
       .pipe(map_column, tl_dict[os.path.splitext(file)[0][0]])
       .pipe(save_txt, os.path.splitext(file)[0], dtp_dict[os.path.splitext(file)[0][0]]))
    print(time.time())

#---------------------------------------------------------------------------------------------------------------
if __name__ == '__main__':
    os.chdir('C:\\Users\Dell\Desktop\Google Drive')
    start_time = time.time()
    pool = multiprocessing.Pool()
    with pool as p:
        p.map(process_dataframes,glob.glob('*.csv'))
    print('Program took ',time.time()-start_time, ' seconds to run')
#--------------------------------------------------------------------------------------------------------------------